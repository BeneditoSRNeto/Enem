






<!DOCTYPE html>
<html>

<head>

    <link rel="stylesheet" type="text/css" href="style.css">

    <meta charset="utf-8">
    <script type="text/javascript" src="../d3.js"></script>
    
    <script type="text/javascript">
    
    let width = 550,
        height = 400,
        margin = 50;
    
    // save state of visual variables to brush and filter
    let svgMap, mapPaths;
    let barsRect, barScales;
    let scatterCircles, scatterScales;
    let raw_geo_data;
    let color = d3.scaleOrdinal(d3.schemeCategory10);
    



    function drawMap(svgMap, geo_data) {

        let projection = d3.geoMercator()
                .scale(250)
                .center([30, -27]); // center of projection

        let path = d3.geoPath().projection(projection);

        mapPaths = svgMap.selectAll("path")
            .data(geo_data.features) // draw feature by feature, do not load all feature collection
            .join("path")
                .attr("d", d => path(d)) // draw feature by feature
                .attr("fill", "#deebf7")
                .attr("stroke", "black")
                .attr("stroke-width", 1)
                .on("click", function(e, d) {
                    handleSelection(d.properties.UF_05); // delegate event
                });
    }

    //function drawBars(svgBars, scales, data) {
    //    let xBars = scales.x;
    //    let yBars = scales.y;


      //  let x_axis = d3.axisBottom(xBars);

      //          d3.select("svg")
      //          .append("g")
      //          .attr("class", "x axis")
      //          .attr("transform", "translate(0," + (height - margin) + ")")
      //          .call(x_axis);

      //  let y_axis = d3.axisLeft(yBars);

        //        d3.select("svg")
         //       .append("g")
         //       .attr("class", "y axis")
          //      .attr("transform", "translate(" + (margin) + ",0)")
          //      .call(y_axis);


// let grouped = d3.rollup(data, 
     //               function(group) {
      //                  let mediaRedacao = d3.mean(group, g => +g["NotaRedacao"]);
                       
                        
              //          return { 
               //             "NotaRedacao" : mediaRedacao
                            
                //        }
                //    },
           //         d => d.UfResidencia
          //      );

//console.log(grouped)

    //    barsRect = svgBars.selectAll("rect")
    //        .data(grouped)
    //        .join("rect")
    //            .attr("x",d => xBars(d))
    ////            .attr("y", d => height - yBars(d.NotaRedacao))
    //            .attr("width", (width/2 - margin)/data.length+20)
    ///            .attr("height", d => yBars(d.NotaRedacao))
     //           .style("fill","teal")
    //            .style("stroke","black")
    //            .on("click", function(e, d) { 
     //               handleSelection(d.UfResidencia); // delegate event
     //           })
      //          ;





  //  }

    function drawScatter(svgScatterplot, scales, data) {
        let xScatter = scales.x;
        let yScatter = scales.y;

let color = d3.scaleOrdinal(d3.schemeCategory10);

         let attendance_extent = d3.extent(data, d => d.NotaRedacao );
                let radius_scale = d3.scaleLinear()
                    .domain(attendance_extent)
                    .range([1,15]);


        scatterCircles = svgScatterplot.selectAll("circle")
            .data(data)
          .join("circle")
              .attr("cx",d => xScatter(d.NotaComp1))
            .attr("cy", d => yScatter(d.NotaComp2))
                .attr("r", d => radius_scale(d.NotaRedacao))

              .style("fill",function (d) { return color(d.CorRaca); })
            .style("stroke","black")
          .on("click", function(e, d) {          
            handleSelection(d.UfResidencia); // delegate event
      });


 let x_axis = d3.axisBottom(xScatter);

                d3.select("svg")
                .append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0," + (height - margin) + ")")
                .call(x_axis);

        let y_axis = d3.axisLeft(yScatter);

              d3.select("svg")
             .append("g")
             .attr("class", "y axis")
            .attr("transform", "translate(" + (margin) + ",0)")
            .call(y_axis);





 }

    function handleSelection(key) {
        
        // reset visual display
        mapPaths.style("fill","#deebf7");
        scatterCircles.style("fill","teal");           
       // barsRect.style("fill","teal");

        // using filter it is possible to get the selection by the key
        mapPaths.filter(d => d.properties.UF_05 === key).style("fill","red");
        scatterCircles.filter(d => d.UfResidencia === key).style("fill","red");
        //barsRect.filter(d => d.UfResidencia === key).style("fill","red");
    }


    function setupVis(data) {

console.log(data)
        // -----------------
        // bars setup
         

      //  let svgBars = d3.select("body").append("svg")
        //    .attr("width", width)
          //  .attr("height", height);
        //let xBars = d3.scaleBand()
          //  .rangeRound([margin, width-margin])
           // .domain(data.map(d => d.NotaRedacao));
        //let yBars = d3.scaleLinear()
          //  .range([height - margin, margin])
         //   .domain([0,d3.max(data, d=>d.NotaRedacao)]);
        //barScales = {"x":xBars, "y":yBars};

        
        

        // -----------------
        // scatterplot setup
        let svgScatterplot = d3.select("body").append("svg")
            .attr("width", width)
            .attr("height", height);
        let xScatter = d3.scaleLinear()
            .rangeRound([margin, width-margin])
            .domain([0,d3.max(data, d=>d.NotaComp1)]);
        let yScatter = d3.scaleLinear()
            .range([height - margin, margin])
            .domain([0,d3.max(data, d=>d.NotaComp2)]);
        scatterScales = {"x":xScatter, "y": yScatter}
        
        

       
       // drawBars(svgBars, barScales, data);
       drawScatter(svgScatterplot, scatterScales, data);



        // ---------------




        // added for filtering
        //raw_data = data; 
       // let slider = d3.select("#filter_slider");
       // let label = d3.select("#label");

      //  let min = 2017, 
      //      max = d3.max(raw_data,d => d.Ano) ;
       // slider
          //  .attr("min", min)
          //  .attr("max", max)
          //  .attr("value", 1)
          //  .attr("step", 1)
           // .on("input", function(e, d) {
           //     label.text(this.value); // use `this` on the place of slider 
          //      let dataFiltered = data.filter(d => d.Ano > this.value); // filter using value
               // drawBars(svgBars, barScales, dataFiltered);
          //      drawScatter(svgScatterplot, scatterScales, dataFiltered);
                
                // get names from filtered data and update features
         //       let keys = dataFiltered.map(d => d.UfResidencia);
         //       let geo_data_filtered = JSON.parse(JSON.stringify(raw_geo_data)); // deep copy of object
        //        geo_data_filtered.features = raw_geo_data.features.filter(d => {
        //            return keys.includes(d.properties.UF_05); // filter by names
        //        })
        //        drawMap(svgMap, geo_data_filtered);
       //         handleSelection({})
      //      });
    }
    </script>
</head>
<body>
        

    <div id="filter_container">
        <label>Events: <input type="range" id="filter_slider"/> </label>
        <p id="label"> </p>
    </div>

    <div class="mapa_brasil"></div>



  

    <script type="text/javascript">



        // load and draw map
        d3.json("uf.json")
            .then(data => {
                raw_geo_data = data;

                // create svg for map
                svgMap = d3.select(".mapa_brasil").append("svg")
                            .attr("width", width)
                            .attr("height", height);

                drawMap(svgMap, data)
            })
            .catch(err => {console.log(err)})
        
        // load and draw all vis
        d3.dsv(";", "ENEM_full.csv")
            .then(setupVis)
            .catch(err => {console.log(err)})



            ///------------------------------


    </script>  

  
</body>
</html>